name: ๐ฌ Video Uploader

on:
  workflow_dispatch:
    inputs:
      content_type:
        description: '๐ฌ ููุน ุงููุญุชูู'
        required: true
        default: 'movie'
        type: choice
        options:
          - movie
          - series
      
      # ุฅุนุฏุงุฏุงุช ุงูุฃููุงู
      movie_url:
        description: '๐ ุฑุงุจุท ุตูุญุฉ ุงููููู'
        required: false
        default: 'https://q.larozavideo.net/play.php?vid=956c7e520'
      movie_title:
        description: '๐ฌ ุงุณู ุงููููู'
        required: false
        default: 'x ูุฑุงุชู'
      
      # ุฅุนุฏุงุฏุงุช ุงููุณูุณูุงุช
      series_name:
        description: '๐บ ุงุณู ุงููุณูุณู (ุฅูุฌููุฒู)'
        required: false
        default: 'afili-ask'
      series_name_arabic:
        description: '๐บ ุงุณู ุงููุณูุณู (ุนุฑุจู)'
        required: false
        default: 'ุงูุญุจ ูุฑุทุฉ'
      season_num:
        description: '๐ฌ ุฑูู ุงูููุณู'
        required: false
        default: '1'
        type: number
      start_episode:
        description: '๐ ุงูุญููุฉ ุงูุฃููู'
        required: false
        default: '13'
        type: number
      end_episode:
        description: '๐ ุงูุญููุฉ ุงูุฃุฎูุฑุฉ'
        required: false
        default: '15'
        type: number

jobs:
  upload-content:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: ๐ฅ Checkout repository
      uses: actions/checkout@v4
    
    - name: ๐ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: โ๏ธ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg python3-pip
    
    - name: ๐ฆ Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ๐ฌ ุฅุนุฏุงุฏ ุงูุฃููุงู
      if: inputs.content_type == 'movie'
      run: |
        echo "๐ฌ ุฅุนุฏุงุฏ ููู ุงูุฃููุงู..."
        
        # ุฅูุดุงุก ููู video_config.json
        cat > video_config.json << 'MOVIE_CONFIG_EOF'
        {
          "videos": [
            {
              "url": "${{ github.event.inputs.movie_url }}",
              "title": "${{ github.event.inputs.movie_title }}"
            }
          ]
        }
        MOVIE_CONFIG_EOF
        
        echo "โ ุชู ุฅูุดุงุก video_config.json:"
        cat video_config.json
        
        # ุนุฑุถ ูุนูููุงุช ุงููููู
        echo ""
        echo "๐ ูุนูููุงุช ุงููููู:"
        echo "๐ฌ ุงูุนููุงู: ${{ github.event.inputs.movie_title }}"
        echo "๐ ุงูุฑุงุจุท: ${{ github.event.inputs.movie_url }}"
        echo "โ๏ธ ุงูุฌูุฏุฉ: 240p (ูุซู ุงููุณูุณูุงุช)"
        echo "๐ ุงูุชุณููุฉ: ุงูุนููุงู ููุท ุจุฏูู ุณูุฉ"
    
    - name: ๐บ ุฅุนุฏุงุฏ ุงููุณูุณูุงุช
      if: inputs.content_type == 'series'
      run: |
        echo "๐บ ุฅุนุฏุงุฏ ููู ุงููุณูุณูุงุช..."
        
        # ุฅูุดุงุก ููู series_config.json
        cat > series_config.json << 'SERIES_CONFIG_EOF'
        {
          "series_name": "${{ github.event.inputs.series_name }}",
          "series_name_arabic": "${{ github.event.inputs.series_name_arabic }}",
          "season_num": ${{ github.event.inputs.season_num }},
          "start_episode": ${{ github.event.inputs.start_episode }},
          "end_episode": ${{ github.event.inputs.end_episode }}
        }
        SERIES_CONFIG_EOF
        
        echo "โ ุชู ุฅูุดุงุก series_config.json:"
        cat series_config.json
        
        # ุญุณุงุจ ุนุฏุฏ ุงูุญููุงุช
        EPISODES_COUNT=$((${{ github.event.inputs.end_episode }} - ${{ github.event.inputs.start_episode }} + 1))
        
        echo ""
        echo "๐ ูุนูููุงุช ุงููุณูุณู:"
        echo "๐บ ุงููุณูุณู: ${{ github.event.inputs.series_name_arabic }}"
        echo "๐ ุงูุงุณู ุงูุฅูุฌููุฒู: ${{ github.event.inputs.series_name }}"
        echo "๐ฌ ุงูููุณู: ${{ github.event.inputs.season_num }}"
        echo "๐ ุงูุญููุงุช: ูู ${{ github.event.inputs.start_episode }} ุฅูู ${{ github.event.inputs.end_episode }}"
        echo "๐ ุงูุนุฏุฏ ุงูุฅุฌูุงูู: $EPISODES_COUNT ุญููุฉ"
        echo "โ๏ธ ุงูุฌูุฏุฉ: 240p"
    
    - name: ๐ ุชุดุบูู ุณูุฑูุจุช ุงูุฃููุงู
      if: inputs.content_type == 'movie'
      env:
        API_ID: ${{ secrets.API_ID }}
        API_HASH: ${{ secrets.API_HASH }}
        CHANNEL: ${{ secrets.CHANNEL }}
        STRING_SESSION: ${{ secrets.STRING_SESSION }}
      run: |
        echo "๐ฌ ุจุฏุก ุฑูุน ุงููููู..."
        echo "โฐ ุงูููุช: $(date)"
        echo "๐ง ุงูุฅุนุฏุงุฏุงุช: 240p, CRF 28 (ูุซู ุงููุณูุณูุงุช)"
        
        # ุชุดุบูู ุณูุฑูุจุช ุงูุฃููุงู ุงูุนุงููู
        python universal_video_uploader.py 2>&1 | tee processing.log
        
        # ุญูุธ ููุฏ ุงูุฎุฑูุฌ
        echo "EXIT_CODE=$?" >> $GITHUB_ENV
    
    - name: ๐ ุชุดุบูู ุณูุฑูุจุช ุงููุณูุณูุงุช
      if: inputs.content_type == 'series'
      env:
        API_ID: ${{ secrets.API_ID }}
        API_HASH: ${{ secrets.API_HASH }}
        CHANNEL: ${{ secrets.CHANNEL }}
        STRING_SESSION: ${{ secrets.STRING_SESSION }}
      run: |
        echo "๐บ ุจุฏุก ุฑูุน ุงููุณูุณู..."
        echo "โฐ ุงูููุช: $(date)"
        echo "๐ง ุงูุฅุนุฏุงุฏุงุช: 240p, CRF 28"
        
        # ุชุดุบูู ุณูุฑูุจุช ุงููุณูุณูุงุช
        python main.py 2>&1 | tee processing.log
        
        # ุญูุธ ููุฏ ุงูุฎุฑูุฌ
        echo "EXIT_CODE=$?" >> $GITHUB_ENV
    
    - name: ๐ค ุฑูุน ุงูุณุฌูุงุช
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ github.event.inputs.content_type }}-${{ github.run_number }}
        path: |
          processing.log
          *_config.json
          *_downloads*/
          movies_*/
          videos_*/
        retention-days: 7
    
    - name: โ ุนุฑุถ ุงููุชุงุฆุฌ
      if: always()
      run: |
        echo ""
        echo "========================================"
        echo "๐ ูุชุงุฆุฌ ุงููุนุงูุฌุฉ"
        echo "========================================"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "โ ุงูุนูููุฉ ุชูุช ุจูุฌุงุญ!"
          
          if [ -f "processing.log" ]; then
            echo ""
            echo "๐ ููุฎุต ูู ุงูุณุฌูุงุช:"
            grep -E "(โ|โ|Successful:|Failed:)" processing.log | tail -20
          fi
        else
          echo "โ ุญุฏุซ ุฎุทุฃ ูู ุงูุนูููุฉ"
          
          if [ -f "processing.log" ]; then
            echo ""
            echo "๐ ุขุฎุฑ 20 ุณุทุฑ ูู ุงูุณุฌูุงุช:"
            tail -20 processing.log
          fi
        fi
        
        echo ""
        echo "๐ก ููุงุญุธุงุช:"
        echo "- ุงูุณุฌูุงุช ูุงููุฉ ูุชุงุญุฉ ูู ูุณู Artifacts"
        echo "- ูููุณุงุนุฏุฉ: ุงูุญุต ุงูุณุฌูุงุช ููุฒูุฏ ูู ุงูุชูุงุตูู"
        echo "- ุชุฐูุฑ: ุงููููุงุช ุงููุญููุฉ ุชู ุญุฐููุง ุจุนุฏ ุงูุฑูุน"
