name: Movie Uploader

on:
  workflow_dispatch:
    inputs:
      script_type:
        description: 'Script type'
        required: true
        default: 'movie'
        type: choice
        options:
          - movie
          - series
      movie_url:
        description: 'Movie URL (optional)'
        required: false
      movie_title:
        description: 'Movie title (optional)'
        required: false

jobs:
  upload-movie:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Ø³Ø§Ø¹ØªÙŠÙ† Ø­Ø¯ Ø£Ù‚ØµÙ‰
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: âš™ï¸ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg python3-pip
    
    - name: ðŸ“¦ Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸŽ¬ Run movie uploader
      if: github.event.inputs.script_type == 'movie'
      env:
        API_ID: ${{ secrets.API_ID }}
        API_HASH: ${{ secrets.API_HASH }}
        CHANNEL: ${{ secrets.CHANNEL }}
        STRING_SESSION: ${{ secrets.STRING_SESSION }}
      run: |
        echo "ðŸš€ Starting Movie Uploader..."
        python movie_uploader.py 2>&1 | tee movie_processing.log
        
        # If specific movie URL provided, create config
        if [ -n "${{ github.event.inputs.movie_url }}" ]; then
          echo "ðŸŽ¬ Creating config for single movie..."
          cat > movie_config.json << EOF
          {
            "movies": [
              {
                "url": "${{ github.event.inputs.movie_url }}",
                "title": "${{ github.event.inputs.movie_title || 'Movie' }}",
                "year": "$(date +%Y)"
              }
            ]
          }
          EOF
          
          echo "ðŸ“‹ Config created:"
          cat movie_config.json
        fi
    
    - name: ðŸ“º Run series uploader
      if: github.event.inputs.script_type == 'series'
      env:
        API_ID: ${{ secrets.API_ID }}
        API_HASH: ${{ secrets.API_HASH }}
        CHANNEL: ${{ secrets.CHANNEL }}
        STRING_SESSION: ${{ secrets.STRING_SESSION }}
      run: |
        echo "ðŸ“º Starting Series Uploader..."
        python main.py 2>&1 | tee series_processing.log
    
    - name: ðŸ“¤ Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: processing-logs-${{ github.event.inputs.script_type }}
        path: |
          *_processing.log
          *_config.json
          *_downloads_*/
        retention-days: 3
